/*
 * Copyright (C) 2014 Stratio (http://stratio.com)
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *         http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package com.stratio.qa.specs;

import com.stratio.qa.utils.ThreadProperty;
import org.testng.annotations.Test;

import java.util.ArrayList;

import static org.assertj.core.api.Assertions.assertThat;

public class CCTTest {

    @Test
    public void testCheckStatusNumberOfTasKHealty() throws Exception {
        ThreadProperty.set("class", this.getClass().getCanonicalName());
        CommonG commong = new CommonG();
        CCTSpec cct = new CCTSpec(commong);
        String response = "{\"id\":\"/s000001/s000001-postgrestls\",\"tenant\":\"s000001\",\"service\":\"postgres\",\"model\":\"default\",\"version\":\"0.7.0\",\"release\":\"0.7\",\"serviceLabel\":\"s000001-postgrestls.s000001\",\"resources\":{\"disk\":36864.0,\"mem\":5120.0,\"gpus\":0.0,\"cpus\":6.0},\"status\":\"RUNNING\",\"healthiness\":\"HEALTHY\",\"tasks\":[{\"id\":\"s000001_s000001-postgrestls.3a0834d5-6d57-11ea-94e2-dec4ac2bea30\",\"name\":\"s000001-postgrestls.s000001\",\"status\":\"RUNNING\",\"healthiness\":\"HEALTHY\",\"timestamp\":1585003230000,\"resources\":{\"disk\":0.0,\"mem\":1024.0,\"gpus\":0.0,\"cpus\":1.0},\"host\":\"10.200.15.26\",\"securedHost\":\"172.16.104.129\",\"frameworkId\":\"s000001-postgrestls.s000001\"},{\"id\":\"c6914a17-c63f-4da3-89e4-0ecfcdec4dd5\",\"name\":\"pg-agent\",\"status\":\"RUNNING\",\"healthiness\":\"UNKNOWN\",\"timestamp\":1585003330000,\"resources\":{\"disk\":0.0,\"mem\":1024.0,\"gpus\":0.0,\"cpus\":2.0},\"host\":\"10.200.15.23\",\"securedHost\":\"172.16.163.138\",\"frameworkId\":\"s000001-postgrestls.s000001\"},{\"id\":\"d516887b-36b1-476f-b068-20d2ca904407\",\"name\":\"pg-0003\",\"status\":\"RUNNING\",\"healthiness\":\"UNKNOWN\",\"timestamp\":1585003296000,\"resources\":{\"disk\":12288.0,\"mem\":1024.0,\"gpus\":0.0,\"cpus\":1.0},\"host\":\"10.200.15.25\",\"securedHost\":\"172.16.114.202\",\"frameworkId\":\"s000001-postgrestls.s000001\"},{\"id\":\"b9135a11-ee80-4e3e-8b6c-f06ca7442dc1\",\"name\":\"pg-0002\",\"status\":\"RUNNING\",\"healthiness\":\"UNKNOWN\",\"timestamp\":1585003262000,\"resources\":{\"disk\":12288.0,\"mem\":1024.0,\"gpus\":0.0,\"cpus\":1.0},\"host\":\"10.200.15.24\",\"securedHost\":\"172.16.58.200\",\"frameworkId\":\"s000001-postgrestls.s000001\"},{\"id\":\"46fee8bb-db18-453b-b9e7-9a9ebb67514f\",\"name\":\"pg-0001\",\"status\":\"RUNNING\",\"healthiness\":\"UNKNOWN\",\"timestamp\":1585003249000,\"resources\":{\"disk\":12288.0,\"mem\":1024.0,\"gpus\":0.0,\"cpus\":1.0},\"host\":\"10.200.15.23\",\"securedHost\":\"172.16.163.137\",\"frameworkId\":\"s000001-postgrestls.s000001\"}],\"exposition\":{\"pattern\":\"pg-0001\",\"port\":\"5432\",\"tags\":[]},\"instances\":1,\"totalTasks\":5,\"totalHealthyTasks\":5,\"networks\":[{\"name\":\"s000001-core\",\"mode\":\"container\",\"labels\":{}}],\"external\":[{\"type\":\"admin\",\"url\":\"https://bootstrap.nightlyforward.labs.stratio.com/service/s000001-postgrestls.s000001\"}],\"env\":{\"POSTGRES_WAL_ARCHIVER_PATH\":\"/tmp\",\"POSTGRES_WAL_ARCHIVER\":\"false\",\"APPNAME\":\"postgrestls\",\"FRAMEWORK_DOCKER_IMAGE\":\"daedalus-qa.labs.stratio.com:5007/stratio/postgresql-community:1.9.1\",\"AGENT_OWNER_REPARENT_WHITELIST\":\"\",\"POSTGRES_GOSEC_SECURITY\":\"true\",\"FRAMEWORK_AVAILABILITY_ZONES_LABEL\":\"dc\",\"FRAMEWORK_DOCKER_RETRY_DELAY_SECONDS\":\"5\",\"FRAMEWORK_AVAILABILITY_ZONES_NUMBER\":\"2\",\"FRAMEWORK_MESOS_ROLE\":\"s000001-postgrestls.s000001\",\"POSTGRES_SECURITY_TYPE\":\"TLS\",\"POSTGRES_ENABLE_HIGH_AVAILABILITY\":\"true\",\"AGENT_OWNER_TO_REPARENT\":\"\",\"FRAMEWORK_ENABLE_AVAILABILITY_ZONES\":\"false\",\"POSTGRES_INDEX_DISK\":\"4096\",\"POSTGRES_WAL_DISK\":\"4096\",\"POSTGRES_RESTORE_SNAPSHOT_LABEL\":\"\",\"POSTGRES_GOSEC_URL_AUTH\":\"bootstrap.nightlyforward.labs.stratio.com\",\"POSTGRES_ASYNC_SLAVE_NODE_PLACEMENT\":\"\",\"FRAMEWORK_ENABLE_MARATHON_SEC\":\"true\",\"FRAMEWORK_ISOLATION_NETWORK_NAME\":\"s000001-core\",\"POSTGRES_GOSEC_ALLOW_IN_PERM_CONFLICT\":\"false\",\"POSTGRES_GOSEC_VERSION\":\"1.4.1\",\"POSTGRES_WAL_ARCHIVER_TYPE\":\"hdfs\",\"FRAMEWORK_DOCKER_LAUNCH_RETRIES\":\"5\",\"FRAMEWORK_ENABLE_MESOS_SEC\":\"true\",\"FRAMEWORK_DOCKER_IMAGE_FORCE_PULL\":\"true\",\"POSTGRES_GOSEC_ALLOW_ORPHAN_RESOURCES\":\"true\",\"POSTGRES_WAL_DISK_TYPE\":\"ROOT\",\"FRAMEWORK_ENABLE_AUTOMATIC_FAILOVER\":\"true\",\"FRAMEWORK_DNS_DOMAIN\":\"mesos\",\"POSTGRES_CPU\":\"1\",\"REALM\":\"NIGHTLYFORWARD.LABS.STRATIO.COM\",\"FRAMEWORK_AVAILABILITY_ZONES_PATTERN\":\"dc(1|2)\",\"POSTGRES_GOSEC_DISABLE_COLUMN_PERMISSIONS\":\"false\",\"FRAMEWORK_ENABLE_API_SECURITY\":\"false\",\"POSTGRES_GOSEC_DOCKER_IMAGE\":\"daedalus-qa.labs.stratio.com:5007/stratio/postgres-agent:1.8.0\",\"POSTGRES_RESTORE_PATH\":\"/tmp/s000001-postgrestls.s000001\",\"POSTGRES_RESTORE_MODE\":\"false\",\"POSTGRES_RESTORE_HDFS_CONFIG_URL\":\"\",\"POSTGRES_AGENT_NODE_PLACEMENT\":\"\",\"FRAMEWORK_INITIAL_INTERNAL_CONFIG\":\"\",\"POSTGRES_LOG_LEVEL\":\"INFO\",\"VAULT_ROLE\":\"s000001\",\"POSTGRES_INDEX_DISK_TYPE\":\"ROOT\",\"POSTGRES_SYNC_SLAVE_NODE_PLACEMENT\":\"\",\"POSTGRES_GOSEC_REVOKE_PUBLIC\":\"false\",\"API_AUTHORIZED_CN\":\"deploy-api\",\"FRAMEWORK_ZOOKEEPER\":\"master.mesos:2181\",\"POSTGRES_GOSEC_LOG_LEVEL\":\"INFO\",\"KADMIN_HOST\":\"kerberos.nightlyforward.labs.stratio.com:749\",\"FRAMEWORK_MESOS_MASTER\":\"master.mesos:2181\",\"FRAMEWORK_LOG_LEVEL\":\"INFO\",\"KDC_UDP_ENABLED\":\"true\",\"FRAMEWORK_ETCD_ENDPOINTS\":\"https://etcd-client.service.eos.nightlyforward.labs.stratio.com:2379\",\"FRAMEWORK_DNS_TYPE\":\"mesos\",\"AGENT_ENABLE_OWNER_REPARENTING\":\"false\",\"KDC_HOST\":\"kerberos.nightlyforward.labs.stratio.com:88\",\"POSTGRES_DATA_DISK_TYPE\":\"ROOT\",\"POSTGRES_GOSEC_SERVICES_URL\":\"gosec-services-daas.marathon.mesos:8443\",\"VAULT_PORT\":\"8200\",\"POSTGRES_VERSION\":\"12\",\"APPROLE\":{\"secret\":\"role\"},\"VAULT_HOSTS\":\"vault.service.eos.nightlyforward.labs.stratio.com\",\"POSTGRES_GOSEC_DOCKER_IMAGE_FORCE_PULL\":\"true\",\"POSTGRES_MEMORY\":\"1024\",\"POSTGRES_MASTER_NODE_PLACEMENT\":\"\",\"POSTGRES_RESTORE_TARGET_TIME\":\"latest\",\"POSTGRES_DATA_DISK\":\"4096\",\"POSTGRES_RESTORE_TYPE\":\"hdfs\",\"POSTGRES_WAL_ARCHIVER_HDFS_CONFIG_URL\":\"\",\"POSTGRES_GOSEC_IDENTITIES_URL\":\"gosec-identities-daas.marathon.mesos:8443\",\"POSTGRES_GOSEC_REFRESH_PERIOD\":\"15\",\"FRAMEWORK_LOST_STATE_TIMEOUT_SECONDS\":\"60\"}}";
        assertThat(cct.checkServiceStatusInResponse("RUNNING", response, 3 , "pg-[\\d]*")).as("Not as expected").isEqualTo(true);
    }

    @Test
    public void testCheckStatusNumberOfTaskOneUnHealthy() throws Exception {
        ThreadProperty.set("class", this.getClass().getCanonicalName());
        CommonG commong = new CommonG();
        CCTSpec cct = new CCTSpec(commong);
        String response = "{\"id\":\"/s000001/s000001-postgrestls\",\"tenant\":\"s000001\",\"service\":\"postgres\",\"model\":\"default\",\"version\":\"0.7.0\",\"release\":\"0.7\",\"serviceLabel\":\"s000001-postgrestls.s000001\",\"resources\":{\"disk\":36864.0,\"mem\":5120.0,\"gpus\":0.0,\"cpus\":6.0},\"status\":\"RUNNING\",\"healthiness\":\"UNHEALTHY\",\"tasks\":[{\"id\":\"s000001_s000001-postgrestls.3a0834d5-6d57-11ea-94e2-dec4ac2bea30\",\"name\":\"s000001-postgrestls.s000001\",\"status\":\"RUNNING\",\"healthiness\":\"HEALTHY\",\"timestamp\":1585003230000,\"resources\":{\"disk\":0.0,\"mem\":1024.0,\"gpus\":0.0,\"cpus\":1.0},\"host\":\"10.200.15.26\",\"securedHost\":\"172.16.104.129\",\"frameworkId\":\"s000001-postgrestls.s000001\"},{\"id\":\"c6914a17-c63f-4da3-89e4-0ecfcdec4dd5\",\"name\":\"pg-agent\",\"status\":\"RUNNING\",\"healthiness\":\"UNKNOWN\",\"timestamp\":1585003330000,\"resources\":{\"disk\":0.0,\"mem\":1024.0,\"gpus\":0.0,\"cpus\":2.0},\"host\":\"10.200.15.23\",\"securedHost\":\"172.16.163.138\",\"frameworkId\":\"s000001-postgrestls.s000001\"},{\"id\":\"d516887b-36b1-476f-b068-20d2ca904407\",\"name\":\"pg-0003\",\"status\":\"RUNNING\",\"healthiness\":\"UNKNOWN\",\"timestamp\":1585003296000,\"resources\":{\"disk\":12288.0,\"mem\":1024.0,\"gpus\":0.0,\"cpus\":1.0},\"host\":\"10.200.15.25\",\"securedHost\":\"172.16.114.202\",\"frameworkId\":\"s000001-postgrestls.s000001\"},{\"id\":\"b9135a11-ee80-4e3e-8b6c-f06ca7442dc1\",\"name\":\"pg-0002\",\"status\":\"RUNNING\",\"healthiness\":\"UNKNOWN\",\"timestamp\":1585003262000,\"resources\":{\"disk\":12288.0,\"mem\":1024.0,\"gpus\":0.0,\"cpus\":1.0},\"host\":\"10.200.15.24\",\"securedHost\":\"172.16.58.200\",\"frameworkId\":\"s000001-postgrestls.s000001\"},{\"id\":\"46fee8bb-db18-453b-b9e7-9a9ebb67514f\",\"name\":\"pg-0001\",\"status\":\"RUNNING\",\"healthiness\":\"UNKNOWN\",\"timestamp\":1585003249000,\"resources\":{\"disk\":12288.0,\"mem\":1024.0,\"gpus\":0.0,\"cpus\":1.0},\"host\":\"10.200.15.23\",\"securedHost\":\"172.16.163.137\",\"frameworkId\":\"s000001-postgrestls.s000001\"}],\"exposition\":{\"pattern\":\"pg-0001\",\"port\":\"5432\",\"tags\":[]},\"instances\":1,\"totalTasks\":5,\"totalHealthyTasks\":5,\"networks\":[{\"name\":\"s000001-core\",\"mode\":\"container\",\"labels\":{}}],\"external\":[{\"type\":\"admin\",\"url\":\"https://bootstrap.nightlyforward.labs.stratio.com/service/s000001-postgrestls.s000001\"}],\"env\":{\"POSTGRES_WAL_ARCHIVER_PATH\":\"/tmp\",\"POSTGRES_WAL_ARCHIVER\":\"false\",\"APPNAME\":\"postgrestls\",\"FRAMEWORK_DOCKER_IMAGE\":\"daedalus-qa.labs.stratio.com:5007/stratio/postgresql-community:1.9.1\",\"AGENT_OWNER_REPARENT_WHITELIST\":\"\",\"POSTGRES_GOSEC_SECURITY\":\"true\",\"FRAMEWORK_AVAILABILITY_ZONES_LABEL\":\"dc\",\"FRAMEWORK_DOCKER_RETRY_DELAY_SECONDS\":\"5\",\"FRAMEWORK_AVAILABILITY_ZONES_NUMBER\":\"2\",\"FRAMEWORK_MESOS_ROLE\":\"s000001-postgrestls.s000001\",\"POSTGRES_SECURITY_TYPE\":\"TLS\",\"POSTGRES_ENABLE_HIGH_AVAILABILITY\":\"true\",\"AGENT_OWNER_TO_REPARENT\":\"\",\"FRAMEWORK_ENABLE_AVAILABILITY_ZONES\":\"false\",\"POSTGRES_INDEX_DISK\":\"4096\",\"POSTGRES_WAL_DISK\":\"4096\",\"POSTGRES_RESTORE_SNAPSHOT_LABEL\":\"\",\"POSTGRES_GOSEC_URL_AUTH\":\"bootstrap.nightlyforward.labs.stratio.com\",\"POSTGRES_ASYNC_SLAVE_NODE_PLACEMENT\":\"\",\"FRAMEWORK_ENABLE_MARATHON_SEC\":\"true\",\"FRAMEWORK_ISOLATION_NETWORK_NAME\":\"s000001-core\",\"POSTGRES_GOSEC_ALLOW_IN_PERM_CONFLICT\":\"false\",\"POSTGRES_GOSEC_VERSION\":\"1.4.1\",\"POSTGRES_WAL_ARCHIVER_TYPE\":\"hdfs\",\"FRAMEWORK_DOCKER_LAUNCH_RETRIES\":\"5\",\"FRAMEWORK_ENABLE_MESOS_SEC\":\"true\",\"FRAMEWORK_DOCKER_IMAGE_FORCE_PULL\":\"true\",\"POSTGRES_GOSEC_ALLOW_ORPHAN_RESOURCES\":\"true\",\"POSTGRES_WAL_DISK_TYPE\":\"ROOT\",\"FRAMEWORK_ENABLE_AUTOMATIC_FAILOVER\":\"true\",\"FRAMEWORK_DNS_DOMAIN\":\"mesos\",\"POSTGRES_CPU\":\"1\",\"REALM\":\"NIGHTLYFORWARD.LABS.STRATIO.COM\",\"FRAMEWORK_AVAILABILITY_ZONES_PATTERN\":\"dc(1|2)\",\"POSTGRES_GOSEC_DISABLE_COLUMN_PERMISSIONS\":\"false\",\"FRAMEWORK_ENABLE_API_SECURITY\":\"false\",\"POSTGRES_GOSEC_DOCKER_IMAGE\":\"daedalus-qa.labs.stratio.com:5007/stratio/postgres-agent:1.8.0\",\"POSTGRES_RESTORE_PATH\":\"/tmp/s000001-postgrestls.s000001\",\"POSTGRES_RESTORE_MODE\":\"false\",\"POSTGRES_RESTORE_HDFS_CONFIG_URL\":\"\",\"POSTGRES_AGENT_NODE_PLACEMENT\":\"\",\"FRAMEWORK_INITIAL_INTERNAL_CONFIG\":\"\",\"POSTGRES_LOG_LEVEL\":\"INFO\",\"VAULT_ROLE\":\"s000001\",\"POSTGRES_INDEX_DISK_TYPE\":\"ROOT\",\"POSTGRES_SYNC_SLAVE_NODE_PLACEMENT\":\"\",\"POSTGRES_GOSEC_REVOKE_PUBLIC\":\"false\",\"API_AUTHORIZED_CN\":\"deploy-api\",\"FRAMEWORK_ZOOKEEPER\":\"master.mesos:2181\",\"POSTGRES_GOSEC_LOG_LEVEL\":\"INFO\",\"KADMIN_HOST\":\"kerberos.nightlyforward.labs.stratio.com:749\",\"FRAMEWORK_MESOS_MASTER\":\"master.mesos:2181\",\"FRAMEWORK_LOG_LEVEL\":\"INFO\",\"KDC_UDP_ENABLED\":\"true\",\"FRAMEWORK_ETCD_ENDPOINTS\":\"https://etcd-client.service.eos.nightlyforward.labs.stratio.com:2379\",\"FRAMEWORK_DNS_TYPE\":\"mesos\",\"AGENT_ENABLE_OWNER_REPARENTING\":\"false\",\"KDC_HOST\":\"kerberos.nightlyforward.labs.stratio.com:88\",\"POSTGRES_DATA_DISK_TYPE\":\"ROOT\",\"POSTGRES_GOSEC_SERVICES_URL\":\"gosec-services-daas.marathon.mesos:8443\",\"VAULT_PORT\":\"8200\",\"POSTGRES_VERSION\":\"12\",\"APPROLE\":{\"secret\":\"role\"},\"VAULT_HOSTS\":\"vault.service.eos.nightlyforward.labs.stratio.com\",\"POSTGRES_GOSEC_DOCKER_IMAGE_FORCE_PULL\":\"true\",\"POSTGRES_MEMORY\":\"1024\",\"POSTGRES_MASTER_NODE_PLACEMENT\":\"\",\"POSTGRES_RESTORE_TARGET_TIME\":\"latest\",\"POSTGRES_DATA_DISK\":\"4096\",\"POSTGRES_RESTORE_TYPE\":\"hdfs\",\"POSTGRES_WAL_ARCHIVER_HDFS_CONFIG_URL\":\"\",\"POSTGRES_GOSEC_IDENTITIES_URL\":\"gosec-identities-daas.marathon.mesos:8443\",\"POSTGRES_GOSEC_REFRESH_PERIOD\":\"15\",\"FRAMEWORK_LOST_STATE_TIMEOUT_SECONDS\":\"60\"}}";
        assertThat(cct.checkServiceStatusInResponse("HEALTHY", response, 3 , "pg-[\\d]*")).as("Not as expected").isEqualTo(false);
    }

    @Test
    public void testCheckStatusOneTasKHealty() throws Exception {
        ThreadProperty.set("class", this.getClass().getCanonicalName());
        CommonG commong = new CommonG();
        CCTSpec cct = new CCTSpec(commong);
        String response = "{\"id\":\"/s000001/s000001-postgrestls\",\"tenant\":\"s000001\",\"service\":\"postgres\",\"model\":\"default\",\"version\":\"0.7.0\",\"release\":\"0.7\",\"serviceLabel\":\"s000001-postgrestls.s000001\",\"resources\":{\"disk\":36864.0,\"mem\":5120.0,\"gpus\":0.0,\"cpus\":6.0},\"status\":\"RUNNING\",\"healthiness\":\"HEALTHY\",\"tasks\":[{\"id\":\"s000001_s000001-postgrestls.3a0834d5-6d57-11ea-94e2-dec4ac2bea30\",\"name\":\"s000001-postgrestls.s000001\",\"status\":\"RUNNING\",\"healthiness\":\"HEALTHY\",\"timestamp\":1585003230000,\"resources\":{\"disk\":0.0,\"mem\":1024.0,\"gpus\":0.0,\"cpus\":1.0},\"host\":\"10.200.15.26\",\"securedHost\":\"172.16.104.129\",\"frameworkId\":\"s000001-postgrestls.s000001\"}],\"env\":{\"POSTGRES_WAL_ARCHIVER_PATH\":\"/tmp\",\"POSTGRES_WAL_ARCHIVER\":\"false\",\"APPNAME\":\"postgrestls\",\"FRAMEWORK_DOCKER_IMAGE\":\"daedalus-qa.labs.stratio.com:5007/stratio/postgresql-community:1.9.1\",\"AGENT_OWNER_REPARENT_WHITELIST\":\"\",\"POSTGRES_GOSEC_SECURITY\":\"true\",\"FRAMEWORK_AVAILABILITY_ZONES_LABEL\":\"dc\",\"FRAMEWORK_DOCKER_RETRY_DELAY_SECONDS\":\"5\",\"FRAMEWORK_AVAILABILITY_ZONES_NUMBER\":\"2\",\"FRAMEWORK_MESOS_ROLE\":\"s000001-postgrestls.s000001\",\"POSTGRES_SECURITY_TYPE\":\"TLS\",\"POSTGRES_ENABLE_HIGH_AVAILABILITY\":\"true\",\"AGENT_OWNER_TO_REPARENT\":\"\",\"FRAMEWORK_ENABLE_AVAILABILITY_ZONES\":\"false\",\"POSTGRES_INDEX_DISK\":\"4096\",\"POSTGRES_WAL_DISK\":\"4096\",\"POSTGRES_RESTORE_SNAPSHOT_LABEL\":\"\",\"POSTGRES_GOSEC_URL_AUTH\":\"bootstrap.nightlyforward.labs.stratio.com\",\"POSTGRES_ASYNC_SLAVE_NODE_PLACEMENT\":\"\",\"FRAMEWORK_ENABLE_MARATHON_SEC\":\"true\",\"FRAMEWORK_ISOLATION_NETWORK_NAME\":\"s000001-core\",\"POSTGRES_GOSEC_ALLOW_IN_PERM_CONFLICT\":\"false\",\"POSTGRES_GOSEC_VERSION\":\"1.4.1\",\"POSTGRES_WAL_ARCHIVER_TYPE\":\"hdfs\",\"FRAMEWORK_DOCKER_LAUNCH_RETRIES\":\"5\",\"FRAMEWORK_ENABLE_MESOS_SEC\":\"true\",\"FRAMEWORK_DOCKER_IMAGE_FORCE_PULL\":\"true\",\"POSTGRES_GOSEC_ALLOW_ORPHAN_RESOURCES\":\"true\",\"POSTGRES_WAL_DISK_TYPE\":\"ROOT\",\"FRAMEWORK_ENABLE_AUTOMATIC_FAILOVER\":\"true\",\"FRAMEWORK_DNS_DOMAIN\":\"mesos\",\"POSTGRES_CPU\":\"1\",\"REALM\":\"NIGHTLYFORWARD.LABS.STRATIO.COM\",\"FRAMEWORK_AVAILABILITY_ZONES_PATTERN\":\"dc(1|2)\",\"POSTGRES_GOSEC_DISABLE_COLUMN_PERMISSIONS\":\"false\",\"FRAMEWORK_ENABLE_API_SECURITY\":\"false\",\"POSTGRES_GOSEC_DOCKER_IMAGE\":\"daedalus-qa.labs.stratio.com:5007/stratio/postgres-agent:1.8.0\",\"POSTGRES_RESTORE_PATH\":\"/tmp/s000001-postgrestls.s000001\",\"POSTGRES_RESTORE_MODE\":\"false\",\"POSTGRES_RESTORE_HDFS_CONFIG_URL\":\"\",\"POSTGRES_AGENT_NODE_PLACEMENT\":\"\",\"FRAMEWORK_INITIAL_INTERNAL_CONFIG\":\"\",\"POSTGRES_LOG_LEVEL\":\"INFO\",\"VAULT_ROLE\":\"s000001\",\"POSTGRES_INDEX_DISK_TYPE\":\"ROOT\",\"POSTGRES_SYNC_SLAVE_NODE_PLACEMENT\":\"\",\"POSTGRES_GOSEC_REVOKE_PUBLIC\":\"false\",\"API_AUTHORIZED_CN\":\"deploy-api\",\"FRAMEWORK_ZOOKEEPER\":\"master.mesos:2181\",\"POSTGRES_GOSEC_LOG_LEVEL\":\"INFO\",\"KADMIN_HOST\":\"kerberos.nightlyforward.labs.stratio.com:749\",\"FRAMEWORK_MESOS_MASTER\":\"master.mesos:2181\",\"FRAMEWORK_LOG_LEVEL\":\"INFO\",\"KDC_UDP_ENABLED\":\"true\",\"FRAMEWORK_ETCD_ENDPOINTS\":\"https://etcd-client.service.eos.nightlyforward.labs.stratio.com:2379\",\"FRAMEWORK_DNS_TYPE\":\"mesos\",\"AGENT_ENABLE_OWNER_REPARENTING\":\"false\",\"KDC_HOST\":\"kerberos.nightlyforward.labs.stratio.com:88\",\"POSTGRES_DATA_DISK_TYPE\":\"ROOT\",\"POSTGRES_GOSEC_SERVICES_URL\":\"gosec-services-daas.marathon.mesos:8443\",\"VAULT_PORT\":\"8200\",\"POSTGRES_VERSION\":\"12\",\"APPROLE\":{\"secret\":\"role\"},\"VAULT_HOSTS\":\"vault.service.eos.nightlyforward.labs.stratio.com\",\"POSTGRES_GOSEC_DOCKER_IMAGE_FORCE_PULL\":\"true\",\"POSTGRES_MEMORY\":\"1024\",\"POSTGRES_MASTER_NODE_PLACEMENT\":\"\",\"POSTGRES_RESTORE_TARGET_TIME\":\"latest\",\"POSTGRES_DATA_DISK\":\"4096\",\"POSTGRES_RESTORE_TYPE\":\"hdfs\",\"POSTGRES_WAL_ARCHIVER_HDFS_CONFIG_URL\":\"\",\"POSTGRES_GOSEC_IDENTITIES_URL\":\"gosec-identities-daas.marathon.mesos:8443\",\"POSTGRES_GOSEC_REFRESH_PERIOD\":\"15\",\"FRAMEWORK_LOST_STATE_TIMEOUT_SECONDS\":\"60\"}}";
        assertThat(cct.checkServiceStatusInResponse("RUNNING", response, null , null)).as("Not as expected").isEqualTo(true);
    }
    @Test
    public void testCheckStatusRealEnvironment() throws Exception {
        ThreadProperty.set("class", this.getClass().getCanonicalName());
        CommonG commong = new CommonG();
        CCTSpec cct = new CCTSpec(commong);
        String response = "{\"id\":\"/qa/qa-postgres\",\"tenant\":\"qa\",\"service\":\"postgres\",\"model\":\"default\",\"version\":\"0.7.0-SNAPSHOT\",\"release\":\"0.7\",\"serviceLabel\":\"qa-postgres.qa\",\"resources\":{\"disk\":36864.0,\"mem\":5120.0,\"gpus\":0.0,\"cpus\":6.0},\"status\":\"RUNNING\",\"healthiness\":\"HEALTHY\",\"tasks\":[{\"id\":\"qa_qa-postgres.5741e73d-5a0e-11ea-a395-6ecedbca9c5c\",\"name\":\"qa-postgres.qa\",\"status\":\"RUNNING\",\"healthiness\":\"HEALTHY\",\"timestamp\":1582882872000,\"resources\":{\"disk\":0.0,\"mem\":1024.0,\"gpus\":0.0,\"cpus\":1.0},\"host\":\"10.130.19.112\",\"securedHost\":\"172.25.72.97\",\"frameworkId\":\"qa-postgres.qa\"},{\"id\":\"95f97473-542b-41c4-8f55-ccc60045b042\",\"name\":\"pg-0002\",\"status\":\"RUNNING\",\"healthiness\":\"UNKNOWN\",\"timestamp\":1582883169000,\"resources\":{\"disk\":12288.0,\"mem\":1024.0,\"gpus\":0.0,\"cpus\":1.0},\"host\":\"10.130.19.104\",\"securedHost\":\"172.25.78.7\",\"frameworkId\":\"qa-postgres.qa\"},{\"id\":\"4aefb519-e2b7-45e8-a2b4-3cbb80984595\",\"name\":\"pg-agent\",\"status\":\"RUNNING\",\"healthiness\":\"UNKNOWN\",\"timestamp\":1584114416000,\"resources\":{\"disk\":0.0,\"mem\":1024.0,\"gpus\":0.0,\"cpus\":2.0},\"host\":\"10.130.19.109\",\"securedHost\":\"172.25.75.146\",\"frameworkId\":\"qa-postgres.qa\"},{\"id\":\"f6cbe235-d6c9-412b-9e1e-5c8ba88043e8\",\"name\":\"pg-0003\",\"status\":\"RUNNING\",\"healthiness\":\"UNKNOWN\",\"timestamp\":1582883315000,\"resources\":{\"disk\":12288.0,\"mem\":1024.0,\"gpus\":0.0,\"cpus\":1.0},\"host\":\"10.130.19.105\",\"securedHost\":\"172.25.70.178\",\"frameworkId\":\"qa-postgres.qa\"},{\"id\":\"bcc93a24-1071-4f4d-a91c-2e654f1cbd14\",\"name\":\"pg-0001\",\"status\":\"RUNNING\",\"healthiness\":\"UNKNOWN\",\"timestamp\":1582883016000,\"resources\":{\"disk\":12288.0,\"mem\":1024.0,\"gpus\":0.0,\"cpus\":1.0},\"host\":\"10.130.19.107\",\"securedHost\":\"172.25.72.7\",\"frameworkId\":\"qa-postgres.qa\"}],\"exposition\":{\"pattern\":\"pg-0001\",\"port\":\"5432\",\"tags\":[]},\"instances\":1,\"totalTasks\":5,\"totalHealthyTasks\":5,\"networks\":[{\"name\":\"qa-core\",\"mode\":\"container\",\"labels\":{}}],\"external\":[{\"type\":\"admin\",\"url\":\"https://bootstrap.echo.hetzner.stratio.com/service/qa-postgres.qa\"}],\"env\":{\"POSTGRES_WAL_ARCHIVER_PATH\":\"/postgresqlarchiver\",\"POSTGRES_WAL_ARCHIVER\":\"false\",\"APPNAME\":\"postgres\",\"FRAMEWORK_DOCKER_IMAGE\":\"qa.stratio.com/stratio/postgresql-community:1.8.2\",\"POSTGRES_GOSEC_SECURITY\":\"true\",\"FRAMEWORK_AVAILABILITY_ZONES_LABEL\":\"dc\",\"FRAMEWORK_DOCKER_RETRY_DELAY_SECONDS\":\"5\",\"FRAMEWORK_AVAILABILITY_ZONES_NUMBER\":\"2\",\"FRAMEWORK_MESOS_ROLE\":\"qa-postgres.qa\",\"POSTGRES_SECURITY_TYPE\":\"TLS\",\"POSTGRES_ENABLE_HIGH_AVAILABILITY\":\"true\",\"FRAMEWORK_ENABLE_AVAILABILITY_ZONES\":\"false\",\"POSTGRES_INDEX_DISK\":\"4096\",\"POSTGRES_WAL_DISK\":\"4096\",\"POSTGRES_RESTORE_SNAPSHOT_LABEL\":\"\",\"POSTGRES_GOSEC_URL_AUTH\":\"bootstrap.echo.hetzner.stratio.com\",\"POSTGRES_ASYNC_SLAVE_NODE_PLACEMENT\":\"\",\"FRAMEWORK_ENABLE_MARATHON_SEC\":\"true\",\"FRAMEWORK_ISOLATION_NETWORK_NAME\":\"qa-core\",\"POSTGRES_GOSEC_ALLOW_IN_PERM_CONFLICT\":\"false\",\"POSTGRES_GOSEC_VERSION\":\"1.1.0\",\"POSTGRES_WAL_ARCHIVER_TYPE\":\"hdfs\",\"FRAMEWORK_DOCKER_LAUNCH_RETRIES\":\"5\",\"FRAMEWORK_ENABLE_MESOS_SEC\":\"true\",\"FRAMEWORK_DOCKER_IMAGE_FORCE_PULL\":\"true\",\"POSTGRES_GOSEC_ALLOW_ORPHAN_RESOURCES\":\"true\",\"POSTGRES_WAL_DISK_TYPE\":\"ROOT\",\"FRAMEWORK_ENABLE_AUTOMATIC_FAILOVER\":\"true\",\"FRAMEWORK_DNS_DOMAIN\":\"mesos\",\"POSTGRES_CPU\":\"1\",\"REALM\":\"STRATIO.COM\",\"FRAMEWORK_AVAILABILITY_ZONES_PATTERN\":\"dc(1|2)\",\"POSTGRES_GOSEC_DISABLE_COLUMN_PERMISSIONS\":\"false\",\"FRAMEWORK_ENABLE_API_SECURITY\":\"false\",\"POSTGRES_GOSEC_DOCKER_IMAGE\":\"qa.stratio.com/stratio/postgres-agent:1.7.1\",\"POSTGRES_RESTORE_PATH\":\"/tmp/postgressec\",\"POSTGRES_RESTORE_MODE\":\"false\",\"POSTGRES_RESTORE_HDFS_CONFIG_URL\":\"\",\"POSTGRES_AGENT_NODE_PLACEMENT\":\"\",\"FRAMEWORK_INITIAL_INTERNAL_CONFIG\":\"\",\"POSTGRES_LOG_LEVEL\":\"INFO\",\"VAULT_ROLE\":\"qa\",\"POSTGRES_INDEX_DISK_TYPE\":\"ROOT\",\"POSTGRES_SYNC_SLAVE_NODE_PLACEMENT\":\"\",\"POSTGRES_GOSEC_REVOKE_PUBLIC\":\"false\",\"API_AUTHORIZED_CN\":\"deploy-api\",\"FRAMEWORK_ZOOKEEPER\":\"master.mesos:2181\",\"POSTGRES_GOSEC_LOG_LEVEL\":\"INFO\",\"KADMIN_HOST\":\"ldapkerberos.echo.hetzner.stratio.com:749\",\"FRAMEWORK_MESOS_MASTER\":\"master.mesos:2181\",\"FRAMEWORK_LOG_LEVEL\":\"INFO\",\"KDC_UDP_ENABLED\":\"true\",\"FRAMEWORK_ETCD_ENDPOINTS\":\"https://etcd-client.service.eos.echo.hetzner.stratio.com:2379\",\"FRAMEWORK_DNS_TYPE\":\"mesos\",\"AGENT_ENABLE_OWNER_REPARENTING\":\"false\",\"KDC_HOST\":\"ldapkerberos.echo.hetzner.stratio.com:88\",\"POSTGRES_DATA_DISK_TYPE\":\"ROOT\",\"POSTGRES_GOSEC_SERVICES_URL\":\"gosec-services-daas.marathon.mesos:8443\",\"VAULT_PORT\":\"8200\",\"POSTGRES_VERSION\":\"12\",\"APPROLE\":{\"secret\":\"role\"},\"VAULT_HOSTS\":\"vault.service.eos.echo.hetzner.stratio.com\",\"POSTGRES_GOSEC_DOCKER_IMAGE_FORCE_PULL\":\"true\",\"POSTGRES_MEMORY\":\"1024\",\"POSTGRES_MASTER_NODE_PLACEMENT\":\"\",\"POSTGRES_RESTORE_TARGET_TIME\":\"latest\",\"POSTGRES_DATA_DISK\":\"4096\",\"POSTGRES_RESTORE_TYPE\":\"hdfs\",\"POSTGRES_WAL_ARCHIVER_HDFS_CONFIG_URL\":\"\",\"POSTGRES_GOSEC_IDENTITIES_URL\":\"gosec-identities-daas.marathon.mesos:8443\",\"POSTGRES_GOSEC_REFRESH_PERIOD\":\"15\",\"FRAMEWORK_LOST_STATE_TIMEOUT_SECONDS\":\"60\"}}";
        assertThat(cct.checkServiceStatusInResponse("RUNNING", response, 3 , "pg-[\\d]*")).as("Not as expected").isEqualTo(true);
    }

    @Test
    public void testObtainMesosTaskIdOfType() throws Exception{
        ThreadProperty.set("class", this.getClass().getCanonicalName());
        CommonG commong = new CommonG();
        CCTSpec cct = new CCTSpec(commong);
        String response = "{\"id\": \"/s000001/s000001-zktest\", \"tenant\": \"s000001\", \"service\": \"zookeeper\", \"model\": \"default\", \"version\": \"0.7.1\", \"release\": \"0.7\", \"serviceLabel\": \"s000001-zktest.s000001\", \"resources\": {\"disk\": 3072, \"mem\": 13312, \"gpus\": 0, \"cpus\": 7 }, \"status\": \"RUNNING\", \"healthiness\": \"HEALTHY\", \"tasks\": [{\"id\": \"s000001_s000001-zktest.d0dcb60e-73e2-11ea-b309-7a267b97061f\", \"name\": \"s000001-zktest.s000001\", \"status\": \"RUNNING\", \"healthiness\": \"HEALTHY\", \"timestamp\": 1585722892000, \"resources\": {\"disk\": 0, \"mem\": 1024, \"gpus\": 0, \"cpus\": 1 }, \"host\": \"10.200.15.19\", \"securedHost\": \"172.16.143.235\", \"frameworkId\": \"s000001-zktest.s000001\"}, {\"id\": \"c84b629b-dc88-4657-9ee5-e79437cdfab7\", \"name\": \"zk-0003\", \"status\": \"RUNNING\", \"healthiness\": \"UNKNOWN\", \"timestamp\": 1585722969000, \"resources\": {\"disk\": 1024, \"mem\": 4096, \"gpus\": 0, \"cpus\": 2 }, \"host\": \"10.200.15.26\", \"securedHost\": \"172.16.104.189\", \"frameworkId\": \"s000001-zktest.s000001\"}, {\"id\": \"81f68e23-0661-4676-8bea-da6aca0c26ad\", \"name\": \"zk-0002\", \"status\": \"RUNNING\", \"healthiness\": \"UNKNOWN\", \"timestamp\": 1585722935000, \"resources\": {\"disk\": 1024, \"mem\": 4096, \"gpus\": 0, \"cpus\": 2 }, \"host\": \"10.200.15.25\", \"securedHost\": \"172.16.114.214\", \"frameworkId\": \"s000001-zktest.s000001\"}, {\"id\": \"fbca6e0c-ffb8-46d0-9e18-e57d35c1379a\", \"name\": \"zk-0001\", \"status\": \"RUNNING\", \"healthiness\": \"UNKNOWN\", \"timestamp\": 1585722910000, \"resources\": {\"disk\": 1024, \"mem\": 4096, \"gpus\": 0, \"cpus\": 2 }, \"host\": \"10.200.15.24\", \"securedHost\": \"172.16.58.197\", \"frameworkId\": \"s000001-zktest.s000001\"} ], \"exposition\": {\"pattern\": \"zk-.*\", \"tags\": [] }, \"instances\": 1, \"totalTasks\": 4, \"totalHealthyTasks\": 4, \"networks\": [{\"name\": \"s000001-core\", \"mode\": \"container\", \"labels\": {} } ], \"external\": [{\"type\": \"admin\", \"url\": \"https://bootstrap.nightlyforward.labs.stratio.com/service/s000001-zktest.s000001\"} ], \"env\": {\"AUTH_PLUGIN_DYPLON_CACHE_USERS_SIZE\": \"1000\", \"APPNAME\": \"zktest\", \"ZOOKEEPER_CPU\": \"2\", \"FRAMEWORK_DOCKER_IMAGE\": \"qa.stratio.com/stratio/zookeeper-docker:2.1.2\", \"ZOOKEEPER_DATA_DISK_TYPE\": \"ROOT\", \"AUTH_PLUGIN_API_SERVER_CACHE_ENABLED\": \"true\", \"FRAMEWORK_AVAILABILITY_ZONES_LABEL\": \"dc\", \"FRAMEWORK_DOCKER_RETRY_DELAY_SECONDS\": \"5\", \"FRAMEWORK_AVAILABILITY_ZONES_NUMBER\": \"2\", \"FRAMEWORK_MESOS_ROLE\": \"s000001-zktest.s000001\", \"AUTH_PLUGIN_DYNAMIC_FILTER_ENDPOINT\": \"https://dyplon-http.marathon.mesos:8443/authorize/dynamicFilter/runQuery?jdbcConnection={JDBC_CONNECTION}&query={QUERY}&tls={TLS}\", \"FRAMEWORK_ENABLE_AVAILABILITY_ZONES\": \"false\", \"AUTH_PLUGIN_FILTER_COLUMNS_ENDPOINT\": \"https://dyplon-http.marathon.mesos:8443/authorize/filter/columns/{user}?service={service}&version={version}&instance={instance}&table={value}\", \"KAFKA_AUDIT_ENABLE\": \"false\", \"AUTH_PLUGIN_DYPLON_CACHE_TAGS_SIZE\": \"1000\", \"FRAMEWORK_ENABLE_MARATHON_SEC\": \"true\", \"FRAMEWORK_ISOLATION_NETWORK_NAME\": \"s000001-core\", \"ZOOKEEPER_INSTANCES\": \"3\", \"AUTH_PLUGIN_FILTER_ROW_ENDPOINT\": \"https://dyplon-http.marathon.mesos:8443/authorize/filter/row/{user}?service={service}&version={version}&instance={instance}&table={value}\", \"CONTAINER_LOGGER_LOGROTATE_STDERR_OPTIONS\": \"rotate 19\", \"AUTH_PLUGIN_FACADE_AUTH_CACHE_ENABLED\": \"true\", \"FRAMEWORK_DOCKER_LAUNCH_RETRIES\": \"5\", \"FRAMEWORK_ENABLE_MESOS_SEC\": \"true\", \"FRAMEWORK_DOCKER_IMAGE_FORCE_PULL\": \"false\", \"AUTH_PLUGIN_DYPLON_CACHE_USERS_TTL\": \"8 min\", \"CONTAINER_LOGGER_MAX_STDOUT_SIZE\": \"10MB\", \"ZOOKEEPER_NODE_PLACEMENT\": \"\", \"AUTH_PLUGIN_FACADE_AUTH_AUDIT_MESSAGE_AS_JSON\": \"true\", \"AUTH_PLUGIN_FACADE_AUTH_MODE\": \"local\", \"AUTH_PLUGIN_DYPLON_CACHE_SERVICES_SIZE\": \"100\", \"AUTH_PLUGIN_VERSION\": \"1.3.1\", \"ZOOKEEPER_DATA_DISK\": \"1024\", \"FRAMEWORK_ENABLE_AUTOMATIC_FAILOVER\": \"true\", \"CONTAINER_LOGGER_MAX_STDERR_SIZE\": \"54MB\", \"FRAMEWORK_DNS_DOMAIN\": \"mesos\", \"AUTH_PLUGIN_DYPLON_CACHE_ENABLED\": \"true\", \"FRAMEWORK_MESOS_PRINCIPAL\": \"open\", \"REALM\": \"NIGHTLYFORWARD.LABS.STRATIO.COM\", \"FRAMEWORK_AVAILABILITY_ZONES_PATTERN\": \"dc(1|2)\", \"AUTH_PLUGIN_FACADE_AUTH_CACHE_TTL\": \"60000 ms\", \"AUTH_PLUGIN_DYPLON_CACHE_POLICIES_TTL\": \"10 min\", \"ZOOKEEPER_LOG_LEVEL\": \"INFO\", \"FRAMEWORK_ENABLE_API_SECURITY\": \"false\", \"ZOOKEEPER_MEMORY\": \"4096\", \"AUTH_PLUGIN_USER_INFO_ENDPOINT\": \"https://dyplon-http.marathon.mesos:8443/user?uid={uid}\", \"AUTH_PLUGIN_DYPLON_CACHE_USERTAGS_TTL\": \"10 min\", \"AUTH_PLUGIN_AUTH_ENDPOINT\": \"https://dyplon-http.marathon.mesos:8443/authorize/{user}?service={service}&version={version}&instance={instance}&action={action}&resourceType={resourceType}&value={value}&hierarchy={hierarchy}\", \"AUTH_PLUGIN_DYPLON_CACHE_USERTAGS_SIZE\": \"1000\", \"VAULT_ROLE\": \"s000001\", \"KAFKA_AUDIT\": \"gosec1.node.paas.labs.stratio.com:9092,gosec2.node.paas.labs.stratio.com:9092,gosec3.node.paas.labs.stratio.com:9092\", \"API_AUTHORIZED_CN\": \"deploy-api\", \"FRAMEWORK_ZOOKEEPER\": \"master.mesos:2181\", \"AUTH_PLUGIN_SERVICE_INFO_ENDPOINT\": \"https://dyplon-http.marathon.mesos:8443/service/instance/info?sid={sid}&version={v}\", \"TASKCFG_ALL_AUTH_PLUGIN_USERTAGS_INFO_ENDPOINT\": \"https://dyplon-http.marathon.mesos:8443/user/tags?user={user}&tenant={tenant}\", \"KADMIN_HOST\": \"kerberos.nightlyforward.labs.stratio.com:749\", \"FRAMEWORK_MESOS_MASTER\": \"master.mesos:2181\", \"FRAMEWORK_LOG_LEVEL\": \"INFO\", \"KDC_UDP_ENABLED\": \"true\", \"KAFKA_AUDIT_TOPIC\": \"audit\", \"CONTAINER_LOGGER_LOGROTATE_STDOUT_OPTIONS\": \"rotate 19\", \"FRAMEWORK_ETCD_ENDPOINTS\": \"https://etcd-client.service.eos.nightlyforward.labs.stratio.com:2379\", \"FRAMEWORK_DNS_TYPE\": \"mesos\", \"KDC_HOST\": \"kerberos.nightlyforward.labs.stratio.com:88\", \"VAULT_PORT\": \"8200\", \"AUTH_PLUGIN_FACADE_AUTH_CACHE_SIZE\": \"100000\", \"APPROLE\": {\"secret\": \"role\"}, \"VAULT_HOSTS\": \"vault.service.eos.nightlyforward.labs.stratio.com\", \"AUTH_PLUGIN_DYPLON_CACHE_TAGS_TTL\": \"10 min\", \"AUTH_PLUGIN_DYPLON_CACHE_POLICIES_SIZE\": \"1000\", \"AUTH_PLUGIN_DYPLON_CACHE_SERVICES_TTL\": \"24 hour\", \"AUTH_PLUGIN_REGISTER_ENDPOINT\": \"https://gosec-services-daas.marathon.mesos:8443/services/\", \"AUTH_PLUGIN_POLICIES_INFO_ENDPOINT\": \"https://dyplon-http.marathon.mesos:8443/policy?uid={uid}&service={service}&tid={tid}\", \"FRAMEWORK_LOST_STATE_TIMEOUT_SECONDS\": \"60\"} }";
        ArrayList<String> res = cct.obtainMesosTaskInfo(response, "zk-[\\d]*", "id");
        assertThat(res.size()).as("Not as expected").isEqualTo(3);
    }

    @Test
    public void testObtainLogsPath() throws Exception{
        ThreadProperty.set("class", this.getClass().getCanonicalName());
        CommonG commong = new CommonG();
        CCTSpec cct = new CCTSpec(commong);
        String response = "{\"links\": [], \"content\": [{\"name\": \"stderr\", \"action\": \"DOWNLOAD\", \"path\": \"/agent/ac239977-84d9-404c-8302-1d839eb54548-S5/files/download?path=/var/lib/mesos/slave/slaves/ac239977-84d9-404c-8302-1d839eb54548-S5/frameworks/24826de7-7ff8-4237-ac51-6d224adb90b7/executors/81f68e23-0661-4676-8bea-da6aca0c26ad/runs/b76e297f-610a-4cd4-9b12-c7b40d12b72d/\", \"isRotated\": false }, {\"name\": \"stderr\", \"action\": \"READ\", \"path\": \"/agent/ac239977-84d9-404c-8302-1d839eb54548-S5/files/read?path=/var/lib/mesos/slave/slaves/ac239977-84d9-404c-8302-1d839eb54548-S5/frameworks/24826de7-7ff8-4237-ac51-6d224adb90b7/executors/81f68e23-0661-4676-8bea-da6aca0c26ad/runs/b76e297f-610a-4cd4-9b12-c7b40d12b72d/\", \"isRotated\": false }, {\"name\": \"stdout\", \"action\": \"DOWNLOAD\", \"path\": \"/agent/ac239977-84d9-404c-8302-1d839eb54548-S5/files/download?path=/var/lib/mesos/slave/slaves/ac239977-84d9-404c-8302-1d839eb54548-S5/frameworks/24826de7-7ff8-4237-ac51-6d224adb90b7/executors/81f68e23-0661-4676-8bea-da6aca0c26ad/runs/b76e297f-610a-4cd4-9b12-c7b40d12b72d/\", \"isRotated\": false }, {\"name\": \"stdout\", \"action\": \"READ\", \"path\": \"/agent/ac239977-84d9-404c-8302-1d839eb54548-S5/files/read?path=/var/lib/mesos/slave/slaves/ac239977-84d9-404c-8302-1d839eb54548-S5/frameworks/24826de7-7ff8-4237-ac51-6d224adb90b7/executors/81f68e23-0661-4676-8bea-da6aca0c26ad/runs/b76e297f-610a-4cd4-9b12-c7b40d12b72d/\", \"isRotated\": false } ] }";
        String res = cct.obtainLogsPath(response,"stdout", "READ");
        assertThat(res).as("Not as expected").isEqualTo("/agent/ac239977-84d9-404c-8302-1d839eb54548-S5/files/read?path=/var/lib/mesos/slave/slaves/ac239977-84d9-404c-8302-1d839eb54548-S5/frameworks/24826de7-7ff8-4237-ac51-6d224adb90b7/executors/81f68e23-0661-4676-8bea-da6aca0c26ad/runs/b76e297f-610a-4cd4-9b12-c7b40d12b72d/");
    }

    @Test
    public void testCheckStatusOneTaskFailedAndLastRunningRealEnvironment() throws Exception{
        ThreadProperty.set("class", this.getClass().getCanonicalName());
        CommonG commong = new CommonG();
        CCTSpec cct = new CCTSpec(commong);
        String response = "{\"id\":\"/qa/qa-postgres\",\"tenant\":\"qa\",\"service\":\"postgres\",\"model\":\"default\",\"version\":\"0.7.1-SNAPSHOT\",\"release\":\"0.7\",\"serviceLabel\":\"qa-postgres.qa\",\"resources\":{\"disk\":36864.0,\"mem\":5120.0,\"gpus\":0.0,\"cpus\":6.0},\"status\":\"RUNNING\",\"healthiness\":\"HEALTHY\",\"tasks\":[{\"id\":\"qa_qa-postgres.8a798bc4-6f36-11ea-910a-460199b84170\",\"name\":\"qa-postgres.qa\",\"status\":\"RUNNING\",\"healthiness\":\"HEALTHY\",\"timestamp\":1585209118000,\"resources\":{\"disk\":0.0,\"mem\":1024.0,\"gpus\":0.0,\"cpus\":1.0},\"host\":\"10.130.19.101\",\"securedHost\":\"172.25.65.98\",\"frameworkId\":\"qa-postgres.qa\"},{\"id\":\"b6603b65-cc9d-4446-9ae1-92d63af15737\",\"name\":\"pg-0002\",\"status\":\"RUNNING\",\"healthiness\":\"UNKNOWN\",\"timestamp\":1585209659000,\"resources\":{\"disk\":12288.0,\"mem\":1024.0,\"gpus\":0.0,\"cpus\":1.0},\"host\":\"10.130.19.104\",\"securedHost\":\"172.25.78.59\",\"frameworkId\":\"qa-postgres.qa\"},{\"id\":\"a98779d9-4a84-4f35-bfd6-34478a97a6ac\",\"name\":\"pg-0001\",\"status\":\"RUNNING\",\"healthiness\":\"UNKNOWN\",\"timestamp\":1585209323000,\"resources\":{\"disk\":12288.0,\"mem\":1024.0,\"gpus\":0.0,\"cpus\":1.0},\"host\":\"10.130.19.107\",\"securedHost\":\"172.25.72.33\",\"frameworkId\":\"qa-postgres.qa\"},{\"id\":\"fe9daa4b-a460-467a-a19c-aa2944503401\",\"name\":\"pg-agent\",\"status\":\"RUNNING\",\"healthiness\":\"UNKNOWN\",\"timestamp\":1587627332000,\"resources\":{\"disk\":0.0,\"mem\":1024.0,\"gpus\":0.0,\"cpus\":2.0},\"host\":\"10.130.19.107\",\"securedHost\":\"172.25.72.49\",\"frameworkId\":\"qa-postgres.qa\"},{\"id\":\"ea269b16-d5bf-4123-84f3-5397408e2b15\",\"name\":\"pg-0003\",\"status\":\"RUNNING\",\"healthiness\":\"UNKNOWN\",\"timestamp\":1585209883000,\"resources\":{\"disk\":12288.0,\"mem\":1024.0,\"gpus\":0.0,\"cpus\":1.0},\"host\":\"10.130.19.105\",\"securedHost\":\"172.25.70.138\",\"frameworkId\":\"qa-postgres.qa\"},{\"id\":\"9d80f31d-25bf-40e0-ab2a-c85bc9689b63\",\"name\":\"pg-agent\",\"status\":\"FAILED\",\"healthiness\":\"UNHEALTHY\",\"timestamp\":1587535728000,\"resources\":{\"disk\":0,\"mem\":0,\"gpus\":0,\"cpus\":0},\"host\":\"10.130.19.102\",\"securedHost\":\"10.130.19.102\",\"frameworkId\":\"qa-postgres.qa\"}],\"exposition\":{\"pattern\":\"pg-0001\",\"port\":\"5432\",\"tags\":[]},\"instances\":1,\"totalTasks\":6,\"totalHealthyTasks\":6,\"networks\":[{\"name\":\"qa-core\",\"mode\":\"container\",\"labels\":{}}],\"external\":[{\"type\":\"admin\",\"url\":\"https://bootstrap.echo.hetzner.stratio.com/service/qa-postgres.qa\"}],\"env\":{\"POSTGRES_WAL_ARCHIVER_PATH\":\"/postgresqlarchiver\",\"POSTGRES_WAL_ARCHIVER\":\"false\",\"APPNAME\":\"postgres\",\"FRAMEWORK_DOCKER_IMAGE\":\"qa.stratio.com/stratio/postgresql-community:1.9.2\",\"POSTGRES_GOSEC_SECURITY\":\"true\",\"FRAMEWORK_AVAILABILITY_ZONES_LABEL\":\"dc\",\"FRAMEWORK_DOCKER_RETRY_DELAY_SECONDS\":\"5\",\"FRAMEWORK_AVAILABILITY_ZONES_NUMBER\":\"2\",\"FRAMEWORK_MESOS_ROLE\":\"qa-postgres.qa\",\"POSTGRES_SECURITY_TYPE\":\"TLS\",\"POSTGRES_ENABLE_HIGH_AVAILABILITY\":\"true\",\"FRAMEWORK_ENABLE_AVAILABILITY_ZONES\":\"false\",\"POSTGRES_INDEX_DISK\":\"4096\",\"POSTGRES_WAL_DISK\":\"4096\",\"POSTGRES_RESTORE_SNAPSHOT_LABEL\":\"\",\"POSTGRES_GOSEC_URL_AUTH\":\"bootstrap.echo.hetzner.stratio.com\",\"POSTGRES_ASYNC_SLAVE_NODE_PLACEMENT\":\"\",\"FRAMEWORK_ENABLE_MARATHON_SEC\":\"true\",\"FRAMEWORK_ISOLATION_NETWORK_NAME\":\"qa-core\",\"POSTGRES_GOSEC_ALLOW_IN_PERM_CONFLICT\":\"false\",\"POSTGRES_GOSEC_VERSION\":\"1.1.0\",\"POSTGRES_WAL_ARCHIVER_TYPE\":\"hdfs\",\"FRAMEWORK_DOCKER_LAUNCH_RETRIES\":\"5\",\"FRAMEWORK_ENABLE_MESOS_SEC\":\"true\",\"FRAMEWORK_DOCKER_IMAGE_FORCE_PULL\":\"true\",\"POSTGRES_GOSEC_ALLOW_ORPHAN_RESOURCES\":\"true\",\"POSTGRES_WAL_DISK_TYPE\":\"ROOT\",\"FRAMEWORK_ENABLE_AUTOMATIC_FAILOVER\":\"true\",\"FRAMEWORK_DNS_DOMAIN\":\"mesos\",\"POSTGRES_CPU\":\"1\",\"REALM\":\"STRATIO.COM\",\"FRAMEWORK_AVAILABILITY_ZONES_PATTERN\":\"dc(1|2)\",\"POSTGRES_GOSEC_DISABLE_COLUMN_PERMISSIONS\":\"false\",\"FRAMEWORK_ENABLE_API_SECURITY\":\"false\",\"POSTGRES_GOSEC_DOCKER_IMAGE\":\"qa.stratio.com/stratio/postgres-agent:1.8.0\",\"POSTGRES_RESTORE_PATH\":\"/tmp/postgressec\",\"POSTGRES_RESTORE_MODE\":\"false\",\"POSTGRES_RESTORE_HDFS_CONFIG_URL\":\"\",\"POSTGRES_AGENT_NODE_PLACEMENT\":\"\",\"FRAMEWORK_INITIAL_INTERNAL_CONFIG\":\"\",\"POSTGRES_LOG_LEVEL\":\"INFO\",\"VAULT_ROLE\":\"qa\",\"POSTGRES_INDEX_DISK_TYPE\":\"ROOT\",\"POSTGRES_SYNC_SLAVE_NODE_PLACEMENT\":\"\",\"POSTGRES_GOSEC_REVOKE_PUBLIC\":\"false\",\"API_AUTHORIZED_CN\":\"deploy-api\",\"FRAMEWORK_ZOOKEEPER\":\"master.mesos:2181\",\"POSTGRES_GOSEC_LOG_LEVEL\":\"INFO\",\"KADMIN_HOST\":\"ldapkerberos.echo.hetzner.stratio.com:749\",\"FRAMEWORK_MESOS_MASTER\":\"master.mesos:2181\",\"FRAMEWORK_LOG_LEVEL\":\"INFO\",\"KDC_UDP_ENABLED\":\"true\",\"FRAMEWORK_ETCD_ENDPOINTS\":\"https://etcd-client.service.eos.echo.hetzner.stratio.com:2379\",\"FRAMEWORK_DNS_TYPE\":\"mesos\",\"AGENT_ENABLE_OWNER_REPARENTING\":\"false\",\"KDC_HOST\":\"ldapkerberos.echo.hetzner.stratio.com:88\",\"POSTGRES_DATA_DISK_TYPE\":\"ROOT\",\"POSTGRES_GOSEC_SERVICES_URL\":\"gosec-services-daas.marathon.mesos:8443\",\"VAULT_PORT\":\"8200\",\"POSTGRES_VERSION\":\"12\",\"APPROLE\":{\"secret\":\"role\"},\"VAULT_HOSTS\":\"vault.service.eos.echo.hetzner.stratio.com\",\"POSTGRES_GOSEC_DOCKER_IMAGE_FORCE_PULL\":\"true\",\"POSTGRES_MEMORY\":\"1024\",\"POSTGRES_MASTER_NODE_PLACEMENT\":\"\",\"POSTGRES_RESTORE_TARGET_TIME\":\"latest\",\"POSTGRES_DATA_DISK\":\"4096\",\"POSTGRES_RESTORE_TYPE\":\"hdfs\",\"POSTGRES_WAL_ARCHIVER_HDFS_CONFIG_URL\":\"\",\"POSTGRES_GOSEC_IDENTITIES_URL\":\"gosec-identities-daas.marathon.mesos:8443\",\"POSTGRES_GOSEC_REFRESH_PERIOD\":\"15\",\"FRAMEWORK_LOST_STATE_TIMEOUT_SECONDS\":\"60\"}}";
        assertThat(cct.checkServiceStatusInResponse("RUNNING", response, 1 , "pg\\-agent")).as("Not as expected").isEqualTo(true);
    }

    @Test
    public void testCheckStatusOneTaskFailedAndLastRunningRealEnvironment2() throws Exception{
        ThreadProperty.set("class", this.getClass().getCanonicalName());
        CommonG commong = new CommonG();
        CCTSpec cct = new CCTSpec(commong);
        String response = "{\"id\":\"/qa/qa-postgres\",\"tenant\":\"qa\",\"service\":\"postgres\",\"model\":\"default\",\"version\":\"0.7.1-SNAPSHOT\",\"release\":\"0.7\",\"serviceLabel\":\"qa-postgres.qa\",\"resources\":{\"disk\":36864.0,\"mem\":5120.0,\"gpus\":0.0,\"cpus\":6.0},\"status\":\"RUNNING\",\"healthiness\":\"HEALTHY\",\"tasks\":[{\"id\":\"qa_qa-postgres.8a798bc4-6f36-11ea-910a-460199b84170\",\"name\":\"qa-postgres.qa\",\"status\":\"RUNNING\",\"healthiness\":\"HEALTHY\",\"timestamp\":1585209118000,\"resources\":{\"disk\":0.0,\"mem\":1024.0,\"gpus\":0.0,\"cpus\":1.0},\"host\":\"10.130.19.101\",\"securedHost\":\"172.25.65.98\",\"frameworkId\":\"qa-postgres.qa\"},{\"id\":\"b6603b65-cc9d-4446-9ae1-92d63af15737\",\"name\":\"pg-0002\",\"status\":\"RUNNING\",\"healthiness\":\"UNKNOWN\",\"timestamp\":1585209659000,\"resources\":{\"disk\":12288.0,\"mem\":1024.0,\"gpus\":0.0,\"cpus\":1.0},\"host\":\"10.130.19.104\",\"securedHost\":\"172.25.78.59\",\"frameworkId\":\"qa-postgres.qa\"},{\"id\":\"a98779d9-4a84-4f35-bfd6-34478a97a6ac\",\"name\":\"pg-0001\",\"status\":\"RUNNING\",\"healthiness\":\"UNKNOWN\",\"timestamp\":1585209323000,\"resources\":{\"disk\":12288.0,\"mem\":1024.0,\"gpus\":0.0,\"cpus\":1.0},\"host\":\"10.130.19.107\",\"securedHost\":\"172.25.72.33\",\"frameworkId\":\"qa-postgres.qa\"},{\"id\":\"fe9daa4b-a460-467a-a19c-aa2944503401\",\"name\":\"pg-agent\",\"status\":\"RUNNING\",\"healthiness\":\"UNKNOWN\",\"timestamp\":1587627332000,\"resources\":{\"disk\":0.0,\"mem\":1024.0,\"gpus\":0.0,\"cpus\":2.0},\"host\":\"10.130.19.107\",\"securedHost\":\"172.25.72.49\",\"frameworkId\":\"qa-postgres.qa\"},{\"id\":\"ea269b16-d5bf-4123-84f3-5397408e2b15\",\"name\":\"pg-0003\",\"status\":\"RUNNING\",\"healthiness\":\"UNKNOWN\",\"timestamp\":1585209883000,\"resources\":{\"disk\":12288.0,\"mem\":1024.0,\"gpus\":0.0,\"cpus\":1.0},\"host\":\"10.130.19.105\",\"securedHost\":\"172.25.70.138\",\"frameworkId\":\"qa-postgres.qa\"},{\"id\":\"9d80f31d-25bf-40e0-ab2a-c85bc9689b63\",\"name\":\"pg-agent\",\"status\":\"FAILED\",\"healthiness\":\"UNHEALTHY\",\"timestamp\":1587535728000,\"resources\":{\"disk\":0,\"mem\":0,\"gpus\":0,\"cpus\":0},\"host\":\"10.130.19.102\",\"securedHost\":\"10.130.19.102\",\"frameworkId\":\"qa-postgres.qa\"}],\"exposition\":{\"pattern\":\"pg-0001\",\"port\":\"5432\",\"tags\":[]},\"instances\":1,\"totalTasks\":6,\"totalHealthyTasks\":6,\"networks\":[{\"name\":\"qa-core\",\"mode\":\"container\",\"labels\":{}}],\"external\":[{\"type\":\"admin\",\"url\":\"https://bootstrap.echo.hetzner.stratio.com/service/qa-postgres.qa\"}],\"env\":{\"POSTGRES_WAL_ARCHIVER_PATH\":\"/postgresqlarchiver\",\"POSTGRES_WAL_ARCHIVER\":\"false\",\"APPNAME\":\"postgres\",\"FRAMEWORK_DOCKER_IMAGE\":\"qa.stratio.com/stratio/postgresql-community:1.9.2\",\"POSTGRES_GOSEC_SECURITY\":\"true\",\"FRAMEWORK_AVAILABILITY_ZONES_LABEL\":\"dc\",\"FRAMEWORK_DOCKER_RETRY_DELAY_SECONDS\":\"5\",\"FRAMEWORK_AVAILABILITY_ZONES_NUMBER\":\"2\",\"FRAMEWORK_MESOS_ROLE\":\"qa-postgres.qa\",\"POSTGRES_SECURITY_TYPE\":\"TLS\",\"POSTGRES_ENABLE_HIGH_AVAILABILITY\":\"true\",\"FRAMEWORK_ENABLE_AVAILABILITY_ZONES\":\"false\",\"POSTGRES_INDEX_DISK\":\"4096\",\"POSTGRES_WAL_DISK\":\"4096\",\"POSTGRES_RESTORE_SNAPSHOT_LABEL\":\"\",\"POSTGRES_GOSEC_URL_AUTH\":\"bootstrap.echo.hetzner.stratio.com\",\"POSTGRES_ASYNC_SLAVE_NODE_PLACEMENT\":\"\",\"FRAMEWORK_ENABLE_MARATHON_SEC\":\"true\",\"FRAMEWORK_ISOLATION_NETWORK_NAME\":\"qa-core\",\"POSTGRES_GOSEC_ALLOW_IN_PERM_CONFLICT\":\"false\",\"POSTGRES_GOSEC_VERSION\":\"1.1.0\",\"POSTGRES_WAL_ARCHIVER_TYPE\":\"hdfs\",\"FRAMEWORK_DOCKER_LAUNCH_RETRIES\":\"5\",\"FRAMEWORK_ENABLE_MESOS_SEC\":\"true\",\"FRAMEWORK_DOCKER_IMAGE_FORCE_PULL\":\"true\",\"POSTGRES_GOSEC_ALLOW_ORPHAN_RESOURCES\":\"true\",\"POSTGRES_WAL_DISK_TYPE\":\"ROOT\",\"FRAMEWORK_ENABLE_AUTOMATIC_FAILOVER\":\"true\",\"FRAMEWORK_DNS_DOMAIN\":\"mesos\",\"POSTGRES_CPU\":\"1\",\"REALM\":\"STRATIO.COM\",\"FRAMEWORK_AVAILABILITY_ZONES_PATTERN\":\"dc(1|2)\",\"POSTGRES_GOSEC_DISABLE_COLUMN_PERMISSIONS\":\"false\",\"FRAMEWORK_ENABLE_API_SECURITY\":\"false\",\"POSTGRES_GOSEC_DOCKER_IMAGE\":\"qa.stratio.com/stratio/postgres-agent:1.8.0\",\"POSTGRES_RESTORE_PATH\":\"/tmp/postgressec\",\"POSTGRES_RESTORE_MODE\":\"false\",\"POSTGRES_RESTORE_HDFS_CONFIG_URL\":\"\",\"POSTGRES_AGENT_NODE_PLACEMENT\":\"\",\"FRAMEWORK_INITIAL_INTERNAL_CONFIG\":\"\",\"POSTGRES_LOG_LEVEL\":\"INFO\",\"VAULT_ROLE\":\"qa\",\"POSTGRES_INDEX_DISK_TYPE\":\"ROOT\",\"POSTGRES_SYNC_SLAVE_NODE_PLACEMENT\":\"\",\"POSTGRES_GOSEC_REVOKE_PUBLIC\":\"false\",\"API_AUTHORIZED_CN\":\"deploy-api\",\"FRAMEWORK_ZOOKEEPER\":\"master.mesos:2181\",\"POSTGRES_GOSEC_LOG_LEVEL\":\"INFO\",\"KADMIN_HOST\":\"ldapkerberos.echo.hetzner.stratio.com:749\",\"FRAMEWORK_MESOS_MASTER\":\"master.mesos:2181\",\"FRAMEWORK_LOG_LEVEL\":\"INFO\",\"KDC_UDP_ENABLED\":\"true\",\"FRAMEWORK_ETCD_ENDPOINTS\":\"https://etcd-client.service.eos.echo.hetzner.stratio.com:2379\",\"FRAMEWORK_DNS_TYPE\":\"mesos\",\"AGENT_ENABLE_OWNER_REPARENTING\":\"false\",\"KDC_HOST\":\"ldapkerberos.echo.hetzner.stratio.com:88\",\"POSTGRES_DATA_DISK_TYPE\":\"ROOT\",\"POSTGRES_GOSEC_SERVICES_URL\":\"gosec-services-daas.marathon.mesos:8443\",\"VAULT_PORT\":\"8200\",\"POSTGRES_VERSION\":\"12\",\"APPROLE\":{\"secret\":\"role\"},\"VAULT_HOSTS\":\"vault.service.eos.echo.hetzner.stratio.com\",\"POSTGRES_GOSEC_DOCKER_IMAGE_FORCE_PULL\":\"true\",\"POSTGRES_MEMORY\":\"1024\",\"POSTGRES_MASTER_NODE_PLACEMENT\":\"\",\"POSTGRES_RESTORE_TARGET_TIME\":\"latest\",\"POSTGRES_DATA_DISK\":\"4096\",\"POSTGRES_RESTORE_TYPE\":\"hdfs\",\"POSTGRES_WAL_ARCHIVER_HDFS_CONFIG_URL\":\"\",\"POSTGRES_GOSEC_IDENTITIES_URL\":\"gosec-identities-daas.marathon.mesos:8443\",\"POSTGRES_GOSEC_REFRESH_PERIOD\":\"15\",\"FRAMEWORK_LOST_STATE_TIMEOUT_SECONDS\":\"60\"}}";
        assertThat(cct.checkServiceStatusInResponse("RUNNING", response, 2 , "pg\\-agent")).as("Not as expected").isEqualTo(false);
    }
}
